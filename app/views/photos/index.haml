!!! 5

%html
  %head
    %title
      Photos
    = stylesheet_link_tag("style")
    = javascript_include_tag("application")
  %body
    .container
      = render :partial => "partial/topbar", :locals => {:user => @user}
      -#%script{:type=>"text/javascript", :src=>"http://hpneo.github.com/gmaps/prettify/prettify.js"}
      = render :partial => "partial/filters_bar"
      %h3
        Viewing:
        %span#viewing #{@viewing}
      /%div
      /  %button
      /    Previous Page
      /  %button
      /    Next Page
      %div.all_pictures
        - if @photos.first != nil
          - @photos.each do |photo|
            %div.pic-thumb-container{:style=>"position:relative;"}
              %div.pic-thumb{:id=>"#{photo.id}"}
                = image_tag photo.photo.url(:small), :class => "pic"
              %div.pic-thumb-descr2
                %span{:style=>"margin:5px;"}
                  = photo.title
              %div.pic-thumb-descr
                %span{:style=>"margin:5px;font-size:0.95em;"}
                  @
                  = User.find_by_id(photo.user_id).username
                .like-button{:id=>"#{photo.id}"}
                  %a.btn
                    - if Like.where("user_id = ? AND photo_id = ?", @user.id.to_i, photo.id.to_i).first == nil
                      %i.icon-thumbs-up
                    - else
                      %i.icon-thumbs-down
                .clear
        - else
          .error-message{:style=>"margin-top:10px;"}
            No photos found.
      .clear
    .black-background#photo-popup-view{:style => "z-index:-10;visibility:hidden;"}
      .black-background-specific
      .popup
        .popup-left
          %img.picpic{:src=>"#{root_url}/assets/lake_fall.jpg"}
        .popup-right
          %div.popup-username-like
            %div.popup-username
              %a{:href=>"/user", :style=>"font-size:1.1em;"}
                amadeus
            %div.popup-like
              %i.icon-thumbs-up
              %span.like-count{:style=>"color:#000"}
                12
          %div.popup-location
            %a.map-popup{:style=>"text-decoration:underline;cursor:pointer;"}
              Berkeley, CA
            %button.btn#go-to-map-view
              Go To Map View
          %div.popup-description
            "Beautiful lake with a nice view of the fall leaf colors."
          .vspacer15
          .hr-divider
          %div.popup-comment-box
            .popup-comment
              %span.popup-comment-username
                %a{:href=>"/userchopin"}
                  &nbsp;chopin:
              %span.popup-comment-text
                Looks inspiring for composing music!
            .popup-comment
              %span.popup-comment-username
                %a{:href=>"/userliszt"}
                  &nbsp;liszt:
              %span.popup-comment-text
                Red, yellow, orange colors look sick.
            %div.popup-comment-input
              %input{:type=>"text", :style=>"width:170px;height:13px;font-size:0.7em;position:relative;top:2px;margin-left:7px;"}
              %a.btn.btn-mini{:style=>"position:relative;top:-3px;"}
                comment
    .black-background#map-popup-view{:style => "z-index:-10;visibility:hidden"}
      .black-background-specific
      .popup.popin
        .popup-left
          #map
        .popup-right
          %button.btn#go-to-photo-view
            Go To Photo View
          -#.map-describe{:style=>"color:#000;"}
          -#  Click on map to update pin's location.
    :javascript
      $(document).ready(function() {
        map = new GMaps({
          div: '#map',
          lat: -12.043333,
          lng: -77.028333,
        });
        map.addMarker({
          lat: 20,
          lng: 30,
        });
        //$("#map").css('width','516px');
        //$("#map").css('height','340px');
        $(".pic-thumb-container .like-button").click(function() {
          photo_id = $(this).attr('id');
          likebutton = $(this);
          $.ajax({
            url: "/add_like",
            data: {
              photo_id: photo_id,
              user_id: "#{@user.id}",
            },
            success: function(data) {
              icon = likebutton.children().children()
              klass = icon.attr('class');
              if (klass == 'icon-thumbs-up') {
                icon.attr('class', 'icon-thumbs-down');
              }
              else {
                icon.attr('class', 'icon-thumbs-up');
              }
            }
          });
        });
        $("#go-to-map-view").click(function() {
          $("#map-popup-view").css("z-index", 10);
          $("#photo-popup-view").css("z-index", -10);
          $("#map-popup-view").css("visibility", "visible");
          $("#photo-popup-view").css("visibility", "hidden");
        });
        $("#go-to-photo-view").click(function() {
          $("#map-popup-view").css("z-index", -10);
          $("#photo-popup-view").css("z-index", 10);
          $("#map-popup-view").css("visibility", "hidden");
          $("#photo-popup-view").css("visibility", "visible");
        });
        var photo_id
        $(".pic-thumb-container .pic").click(function() {
          photo_id = $(this).parent().attr('id');
          $.ajax({
            url: "#{root_path}photoinfo/" + photo_id,
            success: function(data) {
              comments_array = data["comments"];
              number_likes = data["likes"];
              large_photo_url = data["large_photo"];
              city = data["photo"]["city"];
              state = data["photo"]["state"];
              description = data["photo"]["description"];
              title = data["photo"]["title"];
              username = data["username"];

              map.removeMarkers();
              map.setCenter(
                data["photo"]["latitude"],
                data["photo"]["longitude"]
              );
              map.addMarker({
                lat: data["photo"]["latitude"],
                lng: data["photo"]["longitude"],
              });

              $(".popup-left .picpic").attr('src',large_photo_url);
              $(".popup-right .like-count").text(number_likes.toString());
              $(".popup-right .map-popup").text(city + ", " + state);
              $(".popup-right .popup-username a").text(username);
              $(".popup-right .popup-description").text(description);
              $(".popup-right .popup-comment").html('');
              for (i=0; i<comments_array.length; i++) {
                $(".popup-right .popup-comment").append("<div class='popup-comment'" +
                  "<span class='popup-comment-username'><a href=''>" +
                  username + "</a></span>" +
                  "<span class='popup-comment-text'>" +
                  comments_array[i]["comment_text"] +
                  "</span>");
              }

              $("#photo-popup-view").css("z-index", 10);
              $("#photo-popup-view").css("visibility", "visible");
            },
          });
        });
      });





